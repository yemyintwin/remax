<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prototype</title>
    <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/fonts/font-awesome.min.css">
    <link rel="stylesheet" href="assets/fonts/ionicons.min.css">
    <link rel="stylesheet" href="assets/css/dataTables.bootstrap.css">
    <link rel="stylesheet" href="assets/css/Footer-Basic.css">
    <link rel="stylesheet" href="assets/css/kendo.common.min.css">
    <link rel="stylesheet" href="assets/css/kendo.default.min.css">
    <link rel="stylesheet" href="assets/css/kendo.default.mobile.min.css">
    <link rel="stylesheet" href="assets/css/metisMenu.css">
    <link rel="stylesheet" href="assets/css/remax.css">

    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/jquery.cookie.js"></script>
    <script src="assets/js/kendo.all.min.js"></script>
    <script src="assets/js/metisMenu.js"></script>
    <script src="assets/js/remax.js"></script>
    <script src="assets/js/account.js"></script>
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
</head>

<body>
    <div class="container">
        <div class="row">
            <div class="col-md-4 col-md-offset-4">
                <div class="panel panel-default login-panel">
                    <div class="panel-heading">
                        <h3 class="panel-title">Sign In</h3>
                    </div>
                    <div class="panel-body">
                        <div class="form-group"><input type="email" class="form-control" placeholder="Email" id="email" name="email" autofocus="" value="remax@daikai.com"></div>
                        <div class="form-group">
                            <input type="password" class="form-control" placeholder="Password" id="password" name="password" value="mypassword">
                        </div><div class="checkbox"><label><input type="checkbox" name="remember" id="remember" />Remember Me</label></div>
                        <button class="btn btn-default btn-lg btn-success btn-block" type="button" id="login" onclick="login()">Login</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        login = function () {
            sessionStorage.removeItem('tokenKey');

            var loginData = {
                grant_type: 'password',
                username: $('#email').val(),
                password: $('#password').val()
            };

            $('#login').prop('disabled', true);
            $('#login').text("Authenticating...");

            $.ajax({
                type: 'POST',
                dataType: 'json',
                url: Settings.WebApiUrl + '/Token',
                data: loginData
            }).done(function (data) {
                //debugger;
                // Cache the access token in session storage.
                if ($('#remember').prop('checked')) {
                    $.cookie('tokenKey', data.access_token);
                }
                else {
                    localStorage.setItem('tokenKey', data.access_token);
                }
                getCurrentUserInfo(data.access_token);
                //document.location = "/index.html";
            }).fail(function () {
                $('#login').prop('disabled', false);
                $('#login').text("Login");
            });
        }

        getCurrentUserInfo = function (token) {
            if (!token) {
                if (localStorage.getItem('tokenKey')) token = localStorage.getItem('tokenKey').toString();
                else if ($.cookie('tokenKey')) token = $.cookie('tokenKey');
            }

            var currentUser = localStorage.getItem('currentUser');

            if (token) {
                /* Has toekn but no current user */
                if (!currentUser) {
                    $.ajax({
                        type: "POST",
                        dataType: 'json',
                        contentType: "application/json; charset=utf-8",
                        url: Settings.WebApiUrl + '/api/User/GetCurrentUser',
                        data: '{}',
                        beforeSend: function (xhr) {
                            xhr.setRequestHeader('Authorization', 'bearer ' + token);
                        },
                        success: function (data) {
                            localStorage.setItem('currentUser', JSON.stringify(data));
                        },
                        error: function (jqXhr, textStatus, errorThrown) {

                        }
                    });
                }
            }
        }
    </script>
</body>
</html>